---
title: "Schule-Block-Zuordnung"
author: "idalab GmbH"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  pdf_document: default
  html_document: default
header-includes:
- \usepackage{booktabs}
- \usepackage{xcolor}
- \usepackage{longtable}
- \definecolor{BrewerRed}{HTML}{E41A1C}
params:
  NO_ASSIGNMENT: ''
  addresses: ''
  entities: ''
  units: ''
  weights: ''
classoption: a4paper
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE, error=FALSE}
source('../io.R')
source('../addresslist.R')
```

```{r libs, include=FALSE, message=FALSE, warning=FALSE, error=FALSE}
percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}
```

## Adressliste

```{r addresses, results='asis', echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
table = cbind(
  as.data.frame(addresses),
  over(addresses, generate_spatial_df(units, entities, weights, NO_ASSIGNMENT))
  ) %>%
  group_by(entity_id) %>%
  do(data.frame(addresses=to_addresslist(.))) %>%
  arrange(entity_id) %>%
  select(Straße=addresses, Schule=entity_id)

only_schools = table[complete.cases(table),]
unique_schools = match(unique(only_schools$Schule), only_schools$Schule)
table.uniqSchulen.indices = sapply(unique_schools, FUN=function(d) { return(d-1);})
schulen_header = as.character(sapply(table[unique_schools,]$Schule, FUN = function(d) { 
  schule= entities@data %>% filter(entity_id == d)
  return(sprintf("\\textbf{%s, %s} \\\\\n",schule$SCHULNAME, d)); }))
addtorow <- list()
addtorow$pos <- as.list(table.uniqSchulen.indices)
addtorow$command <- schulen_header

print(
  xtable::xtable(table[!is.na(table$Schule),1],align='lp{12cm}'),
  hline.after=table.uniqSchulen.indices,
  include.rownames = FALSE, comment = FALSE,
  add.to.row=addtorow,
  include.colnames = FALSE,
  tabular.environment="longtable", floating=FALSE
)
```

### Ohne Zuordnung

```{r addresses-na, results='asis', echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
print(
  xtable::xtable(table[is.na(table$Schule), c('Straße')], align='lp{14cm}'),
  include.rownames = FALSE, comment = FALSE,
  tabular.environment="longtable", floating=FALSE
)
```