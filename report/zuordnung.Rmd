---
title: "Schule-Block-Zuordnung"
author: "idalab GmbH"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output: pdf_document
params:
  map: ""
  units: ""
  entities: ""
  entity_stats: ""
  assignment: "" 
---

```{r libs, include=FALSE, message=FALSE, warning=FALSE, error=FALSE}
```

## Kartendarstellung der Einzugsbereiche

```{r map, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
tmp_units = broom::tidy(params$units, region = 'unit_id') %>%
  dplyr::inner_join(params$units@data, by = c("id" = "unit_id")) %>%
  dplyr::select(entity_id, group, long, lat)
tmp_entities <- params$entities %>%
  as.data.frame() %>%
  dplyr::select(entity_id, long = coords.x1, lat = coords.x2)

ggmap::ggmap(params$map) +
  ggplot2::geom_polygon(mapping = aes(x = long, y = lat, group = group, fill = entity_id),
                        data = tmp_units) +
  ggplot2::geom_point(mapping = aes(x = long, y = lat),
                      data = tmp_entities) +
  ggplot2::coord_map(xlim = params$units@bbox["x",] + c(-0.01, 0.01),
                          ylim = params$units@bbox["y",] + c(-0.01, 0.01),
                          expand = FALSE) +
  ggplot2::scale_fill_discrete() +
  ggplot2::guides(color = FALSE,
                  fill = FALSE)
```

## Statistik zu den Einzugsbereichen

```{r stats, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
knitr::kable(params$entity_stats)
```

```{r pretty_table, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
```

## Schulen-Bl√∂cke-Zuordnung

```{r solution, results='asis', echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
entity_units <- params$assignment %>%
  dplyr::select(entity_id, unit_id) %>%
  dplyr::group_by(entity_id) %>%
  dplyr::summarise(unit_ids = paste(unit_id, sep = "", collapse = ", "))

for (i in 1:nrow(entity_units)) {
  cat("**", entity_units[[i, "entity_id"]], ":**\n", sep = "")
  cat(entity_units[[i, "unit_ids"]], "\n\n", sep = "")
}
```
